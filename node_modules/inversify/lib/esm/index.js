import"reflect-metadata";export{LazyServiceIdentifier}from"@inversifyjs/common";import{getTargets as n,getClassElementMetadataFromLegacyMetadata as t,ClassElementMetadataKind as e,LegacyTargetImpl as i}from"@inversifyjs/core";const r="named",o="name",s="unmanaged",a="optional",c="inject",d="multi_inject",u="inversify:tagged",h="inversify:tagged_props",l="inversify:paramtypes",g="design:paramtypes",y="post_construct",p="pre_destroy";const f=[c,d,o,s,r,a];var _=Object.freeze({__proto__:null,DESIGN_PARAM_TYPES:g,INJECT_TAG:c,MULTI_INJECT_TAG:d,NAMED_TAG:r,NAME_TAG:o,NON_CUSTOM_TAG_KEYS:f,OPTIONAL_TAG:a,PARAM_TYPES:l,POST_CONSTRUCT:y,PRE_DESTROY:p,TAGGED:u,TAGGED_PROP:h,UNMANAGED_TAG:s});const v={Request:"Request",Singleton:"Singleton",Transient:"Transient"},b={ConstantValue:"ConstantValue",Constructor:"Constructor",DynamicValue:"DynamicValue",Factory:"Factory",Function:"Function",Instance:"Instance",Invalid:"Invalid",Provider:"Provider"},w={ClassProperty:"ClassProperty",ConstructorArgument:"ConstructorArgument",Variable:"Variable"};let m=0;function A(){return m++}class S{id;moduleId;activated;serviceIdentifier;implementationType;cache;dynamicValue;scope;type;factory;provider;constraint;onActivation;onDeactivation;constructor(n,t){this.id=A(),this.activated=!1,this.serviceIdentifier=n,this.scope=t,this.type=b.Invalid,this.constraint=n=>!0,this.implementationType=null,this.cache=null,this.factory=null,this.provider=null,this.onActivation=null,this.onDeactivation=null,this.dynamicValue=null}clone(){const n=new S(this.serviceIdentifier,this.scope);return n.activated=n.scope===v.Singleton&&this.activated,n.implementationType=this.implementationType,n.dynamicValue=this.dynamicValue,n.scope=this.scope,n.type=this.type,n.factory=this.factory,n.provider=this.provider,n.constraint=this.constraint,n.onActivation=this.onActivation,n.onDeactivation=this.onDeactivation,n.cache=this.cache,n}}const I="Metadata key was used more than once in a parameter:",T="NULL argument",D="Key Not Found",N="Ambiguous match found for serviceIdentifier:",C="No matching bindings found for serviceIdentifier:",R="The @inject @multiInject @tagged and @named decorators must be applied to the parameters of a class constructor or a class property.",x=(n,t)=>`onDeactivation() error in class ${n}: ${t}`;class E{getConstructorMetadata(n){return{compilerGeneratedMetadata:Reflect.getMetadata(g,n)??[],userGeneratedMetadata:Reflect.getMetadata(u,n)??{}}}getPropertiesMetadata(n){return Reflect.getMetadata(h,n)??{}}}var M;function q(n){return n instanceof RangeError||"Maximum call stack size exceeded"===n.message}!function(n){n[n.MultipleBindingsAvailable=2]="MultipleBindingsAvailable",n[n.NoBindingsAvailable=0]="NoBindingsAvailable",n[n.OnlyOneBindingAvailable=1]="OnlyOneBindingAvailable"}(M||(M={}));function P(n){return"function"==typeof n?n.name:"symbol"==typeof n?n.toString():n}function B(n,t,e){let i="";const r=e(n,t);return 0!==r.length&&(i="\nRegistered bindings:",r.forEach((n=>{let t="Object";null!==n.implementationType&&(t=j(n.implementationType)),i=`${i}\n ${t}`,n.constraint.metaData&&(i=`${i} - ${n.constraint.metaData}`)}))),i}function F(n,t){return null!==n.parentRequest&&(n.parentRequest.serviceIdentifier===t||F(n.parentRequest,t))}function k(n){n.childRequests.forEach((t=>{if(F(n,t.serviceIdentifier)){const n=function(n){const t=function n(t,e=[]){const i=P(t.serviceIdentifier);return e.push(i),null!==t.parentRequest?n(t.parentRequest,e):e}(n);return t.reverse().join(" --\x3e ")}(t);throw new Error(`Circular dependency found: ${n}`)}k(t)}))}function j(n){if(null!=n.name&&""!==n.name)return n.name;{const t=n.toString(),e=t.match(/^function\s*([^\s(]+)/);return null===e?`Anonymous function: ${t}`:e[1]}}function $(n){return`{"key":"${n.key.toString()}","value":"${n.value.toString()}"}`}class O{id;container;plan;currentRequest;constructor(n){this.id=A(),this.container=n}addPlan(n){this.plan=n}setCurrentRequest(n){this.currentRequest=n}}class V{key;value;constructor(n,t){this.key=n,this.value=t}toString(){return this.key===r?`named: ${String(this.value).toString()} `:`tagged: { key:${this.key.toString()}, value: ${String(this.value)} }`}}class W{parentContext;rootRequest;constructor(n,t){this.parentContext=n,this.rootRequest=t}}function G(t,e){const i=function(n){const t=Object.getPrototypeOf(n.prototype),e=t?.constructor;return e}(e);if(void 0===i||i===Object)return 0;const r=n(t)(i),o=r.map((n=>n.metadata.filter((n=>n.key===s)))),a=[].concat.apply([],o).length,c=r.length-a;return c>0?c:G(t,i)}class K{id;serviceIdentifier;parentContext;parentRequest;bindings;childRequests;target;requestScope;constructor(n,t,e,i,r){this.id=A(),this.serviceIdentifier=n,this.parentContext=t,this.parentRequest=e,this.target=r,this.childRequests=[],this.bindings=Array.isArray(i)?i:[i],this.requestScope=null===e?new Map:null}addChildRequest(n,t,e){const i=new K(n,this.parentContext,this,t,e);return this.childRequests.push(i),i}}function H(n){return n._bindingDictionary}function U(n,t,e,i,r){let o=z(e.container,r.serviceIdentifier),s=[];return o.length===M.NoBindingsAvailable&&!0===e.container.options.autoBindInjectable&&"function"==typeof r.serviceIdentifier&&n.getConstructorMetadata(r.serviceIdentifier).compilerGeneratedMetadata&&(e.container.bind(r.serviceIdentifier).toSelf(),o=z(e.container,r.serviceIdentifier)),s=t?o:o.filter((n=>{const t=new K(n.serviceIdentifier,e,i,n,r);return n.constraint(t)})),function(n,t,e,i,r){switch(t.length){case M.NoBindingsAvailable:if(i.isOptional())return t;{const t=P(n);let o=C;throw o+=function(n,t){if(t.isTagged()||t.isNamed()){let e="";const i=t.getNamedTag(),r=t.getCustomTags();return null!==i&&(e+=$(i)+"\n"),null!==r&&r.forEach((n=>{e+=$(n)+"\n"})),` ${n}\n ${n} - ${e}`}return` ${n}`}(t,i),o+=B(r,t,z),null!==e&&(o+="\n"+`Trying to resolve bindings for "${P(e.serviceIdentifier)}"`),new Error(o)}case M.OnlyOneBindingAvailable:return t;case M.MultipleBindingsAvailable:default:if(i.isArray())return t;{const t=P(n);let e=`${N} ${t}`;throw e+=B(r,t,z),new Error(e)}}}(r.serviceIdentifier,s,i,r,e.container),s}function L(n,t,e,i){const r=[new V(n?d:c,t)];return void 0!==e&&r.push(new V(e,i)),r}function Y(t,e,i,r,o,s){let a,c;if(null===o){a=U(t,e,r,null,s),c=new K(i,r,null,a,s);const n=new W(r,c);r.addPlan(n)}else a=U(t,e,r,o,s),c=o.addChildRequest(s.serviceIdentifier,a,s);a.forEach((e=>{let i=null;if(s.isArray())i=c.addChildRequest(e.serviceIdentifier,e,s);else{if(null!==e.cache)return;i=c}if(e.type===b.Instance&&null!==e.implementationType){const o=function(t,e){return n(t)(e)}(t,e.implementationType);if(!0!==r.container.options.skipBaseClassChecks){const n=G(t,e.implementationType);if(o.length<n){const n=`The number of constructor arguments in the derived class ${j(e.implementationType)} must be >= than the number of constructor arguments of its base class.`;throw new Error(n)}}o.forEach((n=>{Y(t,!1,n.serviceIdentifier,r,i,n)}))}}))}function z(n,t){let e=[];const i=H(n);return i.hasKey(t)?e=i.get(t):null!==n.parent&&(e=z(n.parent,t)),e}function J(n,r,o,s,a,c,d,u=!1){const h=new O(r),l=function(n,r,o,s,a,c){const d=L(n,o,a,c),u=t(d);if(u.kind===e.unmanaged)throw new Error("Unexpected metadata when creating target");return new i(s,u,r)}(o,s,a,"",c,d);try{return Y(n,u,a,h,null,l),h}catch(n){throw q(n)&&k(h.plan.rootRequest),n}}function Q(n){return("object"==typeof n&&null!==n||"function"==typeof n)&&"function"==typeof n.then}function X(n){return!!Q(n)||Array.isArray(n)&&n.some(Q)}const Z=(n,t,e)=>{n.has(t.id)||n.set(t.id,e)},nn=(n,t)=>{n.cache=t,n.activated=!0,Q(t)&&tn(n,t)},tn=async(n,t)=>{try{const e=await t;n.cache=e}catch(t){throw n.cache=null,n.activated=!1,t}};var en;!function(n){n.DynamicValue="toDynamicValue",n.Factory="toFactory",n.Provider="toProvider"}(en||(en={}));const rn=n=>t=>(...e)=>{e.forEach((e=>{n.bind(e).toService(t)}))};function on(n,t,e){let i;if(t.length>0){const r=function(n,t){return n.reduce(((n,e)=>{const i=t(e);return e.target.type===w.ConstructorArgument?n.constructorInjections.push(i):(n.propertyRequests.push(e),n.propertyInjections.push(i)),n.isAsync||(n.isAsync=X(i)),n}),{constructorInjections:[],isAsync:!1,propertyInjections:[],propertyRequests:[]})}(t,e),o={...r,constr:n};i=r.isAsync?async function(n){const t=await an(n.constructorInjections),e=await an(n.propertyInjections);return sn({...n,constructorInjections:t,propertyInjections:e})}(o):sn(o)}else i=new n;return i}function sn(n){const t=new n.constr(...n.constructorInjections);return n.propertyRequests.forEach(((e,i)=>{const r=e.target.identifier,o=n.propertyInjections[i];e.target.isOptional()&&void 0===o||(t[r]=o)})),t}async function an(n){const t=[];for(const e of n)Array.isArray(e)?t.push(Promise.all(e)):t.push(e);return Promise.all(t)}function cn(n,t){const e=function(n,t){if(Reflect.hasMetadata(y,n)){const r=Reflect.getMetadata(y,n);try{return t[r.value]?.()}catch(t){if(t instanceof Error)throw new Error((e=n.name,i=t.message,`@postConstruct error in class ${e}: ${i}`))}}var e,i}(n,t);return Q(e)?e.then((()=>t)):t}function dn(n,t){n.scope!==v.Singleton&&function(n,t){const e=`Class cannot be instantiated in ${n.scope===v.Request?"request":"transient"} scope.`;if("function"==typeof n.onDeactivation)throw new Error(x(t.name,e));if(Reflect.hasMetadata(p,t))throw new Error(`@preDestroy error in class ${t.name}: ${e}`)}(n,t)}const un=n=>t=>{t.parentContext.setCurrentRequest(t);const e=t.bindings,i=t.childRequests,r=t.target&&t.target.isArray(),o=!(t.parentRequest&&t.parentRequest.target&&t.target&&t.parentRequest.target.matchesArray(t.target.serviceIdentifier));if(r&&o)return i.map((t=>un(n)(t)));{if(t.target.isOptional()&&0===e.length)return;const i=e[0];return yn(n,t,i)}},hn=(n,t)=>{const e=(n=>{switch(n.type){case b.Factory:return{factory:n.factory,factoryType:en.Factory};case b.Provider:return{factory:n.provider,factoryType:en.Provider};case b.DynamicValue:return{factory:n.dynamicValue,factoryType:en.DynamicValue};default:throw new Error(`Unexpected factory type ${n.type}`)}})(n);return((n,t)=>{try{return n()}catch(n){if(q(n))throw t();throw n}})((()=>e.factory.bind(n)(t)),(()=>{return new Error((n=e.factoryType,i=t.currentRequest.serviceIdentifier.toString(),`It looks like there is a circular dependency in one of the '${n}' bindings. Please investigate bindings with service identifier '${i}'.`));var n,i}))},ln=(n,t,e)=>{let i;const r=t.childRequests;switch((n=>{let t=null;switch(n.type){case b.ConstantValue:case b.Function:t=n.cache;break;case b.Constructor:case b.Instance:t=n.implementationType;break;case b.DynamicValue:t=n.dynamicValue;break;case b.Provider:t=n.provider;break;case b.Factory:t=n.factory}if(null===t){const t=P(n.serviceIdentifier);throw new Error(`Invalid binding type: ${t}`)}})(e),e.type){case b.ConstantValue:case b.Function:i=e.cache;break;case b.Constructor:i=e.implementationType;break;case b.Instance:i=function(n,t,e,i){dn(n,t);const r=on(t,e,i);return Q(r)?r.then((n=>cn(t,n))):cn(t,r)}(e,e.implementationType,r,un(n));break;default:i=hn(e,t.parentContext)}return i},gn=(n,t,e)=>{let i=((n,t)=>t.scope===v.Singleton&&t.activated?t.cache:t.scope===v.Request&&n.has(t.id)?n.get(t.id):null)(n,t);return null!==i||(i=e(),((n,t,e)=>{t.scope===v.Singleton&&nn(t,e),t.scope===v.Request&&Z(n,t,e)})(n,t,i)),i},yn=(n,t,e)=>gn(n,e,(()=>{let i=ln(n,t,e);return i=Q(i)?i.then((n=>pn(t,e,n))):pn(t,e,i),i}));function pn(n,t,e){let i=fn(n.parentContext,t,e);const r=wn(n.parentContext.container);let o,s=r.next();do{o=s.value;const t=n.parentContext,e=n.serviceIdentifier,a=bn(o,e);i=Q(i)?vn(a,t,i):_n(a,t,i),s=r.next()}while(!0!==s.done&&!H(o).hasKey(n.serviceIdentifier));return i}const fn=(n,t,e)=>{let i;return i="function"==typeof t.onActivation?t.onActivation(n,e):e,i},_n=(n,t,e)=>{let i=n.next();for(;!0!==i.done;){if(Q(e=i.value(t,e)))return vn(n,t,e);i=n.next()}return e},vn=async(n,t,e)=>{let i=await e,r=n.next();for(;!0!==r.done;)i=await r.value(t,i),r=n.next();return i},bn=(n,t)=>{const e=n._activations;return e.hasKey(t)?e.get(t).values():[].values()},wn=n=>{const t=[n];let e=n.parent;for(;null!==e;)t.push(e),e=e.parent;return{next:()=>{const n=t.pop();return void 0!==n?{done:!1,value:n}:{done:!0,value:void 0}}}};const mn=(n,t)=>{const e=n.parentRequest;return null!==e&&(!!t(e)||mn(e,t))},An=n=>t=>{const e=e=>null!==e&&null!==e.target&&e.target.matchesTag(n)(t);return e.metaData=new V(n,t),e},Sn=An(r),In=n=>t=>{let e=null;if(null!==t){if(e=t.bindings[0],"string"==typeof n)return e.serviceIdentifier===n;{const e=t.bindings[0].implementationType;return n===e}}return!1};class Tn{_binding;constructor(n){this._binding=n}when(n){return this._binding.constraint=n,new Dn(this._binding)}whenTargetNamed(n){return this._binding.constraint=Sn(n),new Dn(this._binding)}whenTargetIsDefault(){return this._binding.constraint=n=>{if(null===n)return!1;return null!==n.target&&!n.target.isNamed()&&!n.target.isTagged()},new Dn(this._binding)}whenTargetTagged(n,t){return this._binding.constraint=An(n)(t),new Dn(this._binding)}whenInjectedInto(n){return this._binding.constraint=t=>null!==t&&In(n)(t.parentRequest),new Dn(this._binding)}whenParentNamed(n){return this._binding.constraint=t=>null!==t&&Sn(n)(t.parentRequest),new Dn(this._binding)}whenParentTagged(n,t){return this._binding.constraint=e=>null!==e&&An(n)(t)(e.parentRequest),new Dn(this._binding)}whenAnyAncestorIs(n){return this._binding.constraint=t=>null!==t&&mn(t,In(n)),new Dn(this._binding)}whenNoAncestorIs(n){return this._binding.constraint=t=>null!==t&&!mn(t,In(n)),new Dn(this._binding)}whenAnyAncestorNamed(n){return this._binding.constraint=t=>null!==t&&mn(t,Sn(n)),new Dn(this._binding)}whenNoAncestorNamed(n){return this._binding.constraint=t=>null!==t&&!mn(t,Sn(n)),new Dn(this._binding)}whenAnyAncestorTagged(n,t){return this._binding.constraint=e=>null!==e&&mn(e,An(n)(t)),new Dn(this._binding)}whenNoAncestorTagged(n,t){return this._binding.constraint=e=>null!==e&&!mn(e,An(n)(t)),new Dn(this._binding)}whenAnyAncestorMatches(n){return this._binding.constraint=t=>null!==t&&mn(t,n),new Dn(this._binding)}whenNoAncestorMatches(n){return this._binding.constraint=t=>null!==t&&!mn(t,n),new Dn(this._binding)}}class Dn{_binding;constructor(n){this._binding=n}onActivation(n){return this._binding.onActivation=n,new Tn(this._binding)}onDeactivation(n){return this._binding.onDeactivation=n,new Tn(this._binding)}}class Nn{_bindingWhenSyntax;_bindingOnSyntax;_binding;constructor(n){this._binding=n,this._bindingWhenSyntax=new Tn(this._binding),this._bindingOnSyntax=new Dn(this._binding)}when(n){return this._bindingWhenSyntax.when(n)}whenTargetNamed(n){return this._bindingWhenSyntax.whenTargetNamed(n)}whenTargetIsDefault(){return this._bindingWhenSyntax.whenTargetIsDefault()}whenTargetTagged(n,t){return this._bindingWhenSyntax.whenTargetTagged(n,t)}whenInjectedInto(n){return this._bindingWhenSyntax.whenInjectedInto(n)}whenParentNamed(n){return this._bindingWhenSyntax.whenParentNamed(n)}whenParentTagged(n,t){return this._bindingWhenSyntax.whenParentTagged(n,t)}whenAnyAncestorIs(n){return this._bindingWhenSyntax.whenAnyAncestorIs(n)}whenNoAncestorIs(n){return this._bindingWhenSyntax.whenNoAncestorIs(n)}whenAnyAncestorNamed(n){return this._bindingWhenSyntax.whenAnyAncestorNamed(n)}whenAnyAncestorTagged(n,t){return this._bindingWhenSyntax.whenAnyAncestorTagged(n,t)}whenNoAncestorNamed(n){return this._bindingWhenSyntax.whenNoAncestorNamed(n)}whenNoAncestorTagged(n,t){return this._bindingWhenSyntax.whenNoAncestorTagged(n,t)}whenAnyAncestorMatches(n){return this._bindingWhenSyntax.whenAnyAncestorMatches(n)}whenNoAncestorMatches(n){return this._bindingWhenSyntax.whenNoAncestorMatches(n)}onActivation(n){return this._bindingOnSyntax.onActivation(n)}onDeactivation(n){return this._bindingOnSyntax.onDeactivation(n)}}class Cn{_binding;constructor(n){this._binding=n}inRequestScope(){return this._binding.scope=v.Request,new Nn(this._binding)}inSingletonScope(){return this._binding.scope=v.Singleton,new Nn(this._binding)}inTransientScope(){return this._binding.scope=v.Transient,new Nn(this._binding)}}class Rn{_bindingInSyntax;_bindingWhenSyntax;_bindingOnSyntax;_binding;constructor(n){this._binding=n,this._bindingWhenSyntax=new Tn(this._binding),this._bindingOnSyntax=new Dn(this._binding),this._bindingInSyntax=new Cn(n)}inRequestScope(){return this._bindingInSyntax.inRequestScope()}inSingletonScope(){return this._bindingInSyntax.inSingletonScope()}inTransientScope(){return this._bindingInSyntax.inTransientScope()}when(n){return this._bindingWhenSyntax.when(n)}whenTargetNamed(n){return this._bindingWhenSyntax.whenTargetNamed(n)}whenTargetIsDefault(){return this._bindingWhenSyntax.whenTargetIsDefault()}whenTargetTagged(n,t){return this._bindingWhenSyntax.whenTargetTagged(n,t)}whenInjectedInto(n){return this._bindingWhenSyntax.whenInjectedInto(n)}whenParentNamed(n){return this._bindingWhenSyntax.whenParentNamed(n)}whenParentTagged(n,t){return this._bindingWhenSyntax.whenParentTagged(n,t)}whenAnyAncestorIs(n){return this._bindingWhenSyntax.whenAnyAncestorIs(n)}whenNoAncestorIs(n){return this._bindingWhenSyntax.whenNoAncestorIs(n)}whenAnyAncestorNamed(n){return this._bindingWhenSyntax.whenAnyAncestorNamed(n)}whenAnyAncestorTagged(n,t){return this._bindingWhenSyntax.whenAnyAncestorTagged(n,t)}whenNoAncestorNamed(n){return this._bindingWhenSyntax.whenNoAncestorNamed(n)}whenNoAncestorTagged(n,t){return this._bindingWhenSyntax.whenNoAncestorTagged(n,t)}whenAnyAncestorMatches(n){return this._bindingWhenSyntax.whenAnyAncestorMatches(n)}whenNoAncestorMatches(n){return this._bindingWhenSyntax.whenNoAncestorMatches(n)}onActivation(n){return this._bindingOnSyntax.onActivation(n)}onDeactivation(n){return this._bindingOnSyntax.onDeactivation(n)}}class xn{_binding;constructor(n){this._binding=n}to(n){return this._binding.type=b.Instance,this._binding.implementationType=n,new Rn(this._binding)}toSelf(){if("function"!=typeof this._binding.serviceIdentifier)throw new Error("The toSelf function can only be applied when a constructor is used as service identifier");const n=this._binding.serviceIdentifier;return this.to(n)}toConstantValue(n){return this._binding.type=b.ConstantValue,this._binding.cache=n,this._binding.dynamicValue=null,this._binding.implementationType=null,this._binding.scope=v.Singleton,new Nn(this._binding)}toDynamicValue(n){return this._binding.type=b.DynamicValue,this._binding.cache=null,this._binding.dynamicValue=n,this._binding.implementationType=null,new Rn(this._binding)}toConstructor(n){return this._binding.type=b.Constructor,this._binding.implementationType=n,this._binding.scope=v.Singleton,new Nn(this._binding)}toFactory(n){return this._binding.type=b.Factory,this._binding.factory=n,this._binding.scope=v.Singleton,new Nn(this._binding)}toFunction(n){if("function"!=typeof n)throw new Error("Value provided to function binding must be a function!");const t=this.toConstantValue(n);return this._binding.type=b.Function,this._binding.scope=v.Singleton,t}toAutoFactory(n){return this._binding.type=b.Factory,this._binding.factory=t=>()=>t.container.get(n),this._binding.scope=v.Singleton,new Nn(this._binding)}toAutoNamedFactory(n){return this._binding.type=b.Factory,this._binding.factory=t=>e=>t.container.getNamed(n,e),new Nn(this._binding)}toProvider(n){return this._binding.type=b.Provider,this._binding.provider=n,this._binding.scope=v.Singleton,new Nn(this._binding)}toService(n){this._binding.type=b.DynamicValue,Object.defineProperty(this._binding,"cache",{configurable:!0,enumerable:!0,get:()=>null,set(n){}}),this._binding.dynamicValue=t=>{try{return t.container.get(n)}catch(e){return t.container.getAsync(n)}},this._binding.implementationType=null}}class En{bindings;activations;deactivations;middleware;moduleActivationStore;static of(n,t,e,i,r){const o=new En;return o.bindings=n,o.middleware=t,o.deactivations=i,o.activations=e,o.moduleActivationStore=r,o}}class Mn{_map;constructor(){this._map=new Map}getMap(){return this._map}add(n,t){if(this._checkNonNulish(n),null==t)throw new Error(T);const e=this._map.get(n);void 0!==e?e.push(t):this._map.set(n,[t])}get(n){this._checkNonNulish(n);const t=this._map.get(n);if(void 0!==t)return t;throw new Error(D)}remove(n){if(this._checkNonNulish(n),!this._map.delete(n))throw new Error(D)}removeIntersection(n){this.traverse(((t,e)=>{const i=n.hasKey(t)?n.get(t):void 0;if(void 0!==i){const n=e.filter((n=>!i.some((t=>n===t))));this._setValue(t,n)}}))}removeByCondition(n){const t=[];return this._map.forEach(((e,i)=>{const r=[];for(const i of e){n(i)?t.push(i):r.push(i)}this._setValue(i,r)})),t}hasKey(n){return this._checkNonNulish(n),this._map.has(n)}clone(){const n=new Mn;return this._map.forEach(((t,e)=>{t.forEach((t=>{var i;n.add(e,"object"==typeof(i=t)&&null!==i&&"clone"in i&&"function"==typeof i.clone?t.clone():t)}))})),n}traverse(n){this._map.forEach(((t,e)=>{n(e,t)}))}_checkNonNulish(n){if(null==n)throw new Error(T)}_setValue(n,t){t.length>0?this._map.set(n,t):this._map.delete(n)}}class qn{_map=new Map;remove(n){const t=this._map.get(n);return void 0===t?this._getEmptyHandlersStore():(this._map.delete(n),t)}addDeactivation(n,t,e){this._getModuleActivationHandlers(n).onDeactivations.add(t,e)}addActivation(n,t,e){this._getModuleActivationHandlers(n).onActivations.add(t,e)}clone(){const n=new qn;return this._map.forEach(((t,e)=>{n._map.set(e,{onActivations:t.onActivations.clone(),onDeactivations:t.onDeactivations.clone()})})),n}_getModuleActivationHandlers(n){let t=this._map.get(n);return void 0===t&&(t=this._getEmptyHandlersStore(),this._map.set(n,t)),t}_getEmptyHandlersStore(){return{onActivations:new Mn,onDeactivations:new Mn}}}class Pn{id;parent;options;_middleware;_bindingDictionary;_activations;_deactivations;_snapshots;_metadataReader;_moduleActivationStore;constructor(n){const t=n||{};if("object"!=typeof t)throw new Error("Invalid Container constructor argument. Container options must be an object.");if(void 0===t.defaultScope)t.defaultScope=v.Transient;else if(t.defaultScope!==v.Singleton&&t.defaultScope!==v.Transient&&t.defaultScope!==v.Request)throw new Error('Invalid Container option. Default scope must be a string ("singleton" or "transient").');if(void 0===t.autoBindInjectable)t.autoBindInjectable=!1;else if("boolean"!=typeof t.autoBindInjectable)throw new Error("Invalid Container option. Auto bind injectable must be a boolean");if(void 0===t.skipBaseClassChecks)t.skipBaseClassChecks=!1;else if("boolean"!=typeof t.skipBaseClassChecks)throw new Error("Invalid Container option. Skip base check must be a boolean");this.options={autoBindInjectable:t.autoBindInjectable,defaultScope:t.defaultScope,skipBaseClassChecks:t.skipBaseClassChecks},this.id=A(),this._bindingDictionary=new Mn,this._snapshots=[],this._middleware=null,this._activations=new Mn,this._deactivations=new Mn,this.parent=null,this._metadataReader=new E,this._moduleActivationStore=new qn}static merge(n,t,...e){const i=new Pn,r=[n,t,...e].map((n=>H(n))),o=H(i);return r.forEach((n=>{var t;t=o,n.traverse(((n,e)=>{e.forEach((n=>{t.add(n.serviceIdentifier,n.clone())}))}))})),i}load(...n){const t=this._getContainerModuleHelpersFactory();for(const e of n){const n=t(e.id);e.registry(n.bindFunction,n.unbindFunction,n.isboundFunction,n.rebindFunction,n.unbindAsyncFunction,n.onActivationFunction,n.onDeactivationFunction)}}async loadAsync(...n){const t=this._getContainerModuleHelpersFactory();for(const e of n){const n=t(e.id);await e.registry(n.bindFunction,n.unbindFunction,n.isboundFunction,n.rebindFunction,n.unbindAsyncFunction,n.onActivationFunction,n.onDeactivationFunction)}}unload(...n){n.forEach((n=>{const t=this._removeModuleBindings(n.id);this._deactivateSingletons(t),this._removeModuleHandlers(n.id)}))}async unloadAsync(...n){for(const t of n){const n=this._removeModuleBindings(t.id);await this._deactivateSingletonsAsync(n),this._removeModuleHandlers(t.id)}}bind(n){return this._bind(this._buildBinding(n))}rebind(n){return this.unbind(n),this.bind(n)}async rebindAsync(n){return await this.unbindAsync(n),this.bind(n)}unbind(n){if(this._bindingDictionary.hasKey(n)){const t=this._bindingDictionary.get(n);this._deactivateSingletons(t)}this._removeServiceFromDictionary(n)}async unbindAsync(n){if(this._bindingDictionary.hasKey(n)){const t=this._bindingDictionary.get(n);await this._deactivateSingletonsAsync(t)}this._removeServiceFromDictionary(n)}unbindAll(){this._bindingDictionary.traverse(((n,t)=>{this._deactivateSingletons(t)})),this._bindingDictionary=new Mn}async unbindAllAsync(){const n=[];this._bindingDictionary.traverse(((t,e)=>{n.push(this._deactivateSingletonsAsync(e))})),await Promise.all(n),this._bindingDictionary=new Mn}onActivation(n,t){this._activations.add(n,t)}onDeactivation(n,t){this._deactivations.add(n,t)}isBound(n){let t=this._bindingDictionary.hasKey(n);return!t&&this.parent&&(t=this.parent.isBound(n)),t}isCurrentBound(n){return this._bindingDictionary.hasKey(n)}isBoundNamed(n,t){return this.isBoundTagged(n,r,t)}isBoundTagged(n,r,o){let s=!1;if(this._bindingDictionary.hasKey(n)){const a=this._bindingDictionary.get(n),c=function(n,r,o,s){const a=L(!1,r,o,s),c=t(a);if(c.kind===e.unmanaged)throw new Error("Unexpected metadata when creating target");const d=new i("",c,"Variable"),u=new O(n);return new K(r,u,null,[],d)}(this,n,r,o);s=a.some((n=>n.constraint(c)))}return!s&&this.parent&&(s=this.parent.isBoundTagged(n,r,o)),s}snapshot(){this._snapshots.push(En.of(this._bindingDictionary.clone(),this._middleware,this._activations.clone(),this._deactivations.clone(),this._moduleActivationStore.clone()))}restore(){const n=this._snapshots.pop();if(void 0===n)throw new Error("No snapshot available to restore.");this._bindingDictionary=n.bindings,this._activations=n.activations,this._deactivations=n.deactivations,this._middleware=n.middleware,this._moduleActivationStore=n.moduleActivationStore}createChild(n){const t=new Pn(n||this.options);return t.parent=this,t}applyMiddleware(...n){const t=this._middleware?this._middleware:this._planAndResolve();this._middleware=n.reduce(((n,t)=>t(n)),t)}applyCustomMetadataReader(n){this._metadataReader=n}get(n){const t=this._getNotAllArgs(n,!1);return this._getButThrowIfAsync(t)}async getAsync(n){const t=this._getNotAllArgs(n,!1);return this._get(t)}getTagged(n,t,e){const i=this._getNotAllArgs(n,!1,t,e);return this._getButThrowIfAsync(i)}async getTaggedAsync(n,t,e){const i=this._getNotAllArgs(n,!1,t,e);return this._get(i)}getNamed(n,t){return this.getTagged(n,r,t)}async getNamedAsync(n,t){return this.getTaggedAsync(n,r,t)}getAll(n){const t=this._getAllArgs(n);return this._getButThrowIfAsync(t)}async getAllAsync(n){const t=this._getAllArgs(n);return this._getAll(t)}getAllTagged(n,t,e){const i=this._getNotAllArgs(n,!0,t,e);return this._getButThrowIfAsync(i)}async getAllTaggedAsync(n,t,e){const i=this._getNotAllArgs(n,!0,t,e);return this._getAll(i)}getAllNamed(n,t){return this.getAllTagged(n,r,t)}async getAllNamedAsync(n,t){return this.getAllTaggedAsync(n,r,t)}resolve(n){const t=this.isBound(n);t||this.bind(n).toSelf();const e=this.get(n);return t||this.unbind(n),e}_preDestroy(n,t){if(void 0!==n&&Reflect.hasMetadata(p,n)){const e=Reflect.getMetadata(p,n);return t[e.value]?.()}}_removeModuleHandlers(n){const t=this._moduleActivationStore.remove(n);this._activations.removeIntersection(t.onActivations),this._deactivations.removeIntersection(t.onDeactivations)}_removeModuleBindings(n){return this._bindingDictionary.removeByCondition((t=>t.moduleId===n))}_deactivate(n,t){const e=null==t?void 0:Object.getPrototypeOf(t).constructor;try{if(this._deactivations.hasKey(n.serviceIdentifier)){const i=this._deactivateContainer(t,this._deactivations.get(n.serviceIdentifier).values());if(Q(i))return this._handleDeactivationError(i.then((async()=>this._propagateContainerDeactivationThenBindingAndPreDestroyAsync(n,t,e))),n.serviceIdentifier)}const i=this._propagateContainerDeactivationThenBindingAndPreDestroy(n,t,e);if(Q(i))return this._handleDeactivationError(i,n.serviceIdentifier)}catch(t){if(t instanceof Error)throw new Error(x(P(n.serviceIdentifier),t.message))}}async _handleDeactivationError(n,t){try{await n}catch(n){if(n instanceof Error)throw new Error(x(P(t),n.message))}}_deactivateContainer(n,t){let e=t.next();for(;"function"==typeof e.value;){const i=e.value(n);if(Q(i))return i.then((async()=>this._deactivateContainerAsync(n,t)));e=t.next()}}async _deactivateContainerAsync(n,t){let e=t.next();for(;"function"==typeof e.value;)await e.value(n),e=t.next()}_getContainerModuleHelpersFactory(){const n=n=>t=>{const e=this._buildBinding(t);return e.moduleId=n,this._bind(e)},t=()=>n=>{this.unbind(n)},e=()=>async n=>this.unbindAsync(n),i=()=>n=>this.isBound(n),r=t=>{const e=n(t);return n=>(this.unbind(n),e(n))},o=n=>(t,e)=>{this._moduleActivationStore.addActivation(n,t,e),this.onActivation(t,e)},s=n=>(t,e)=>{this._moduleActivationStore.addDeactivation(n,t,e),this.onDeactivation(t,e)};return a=>({bindFunction:n(a),isboundFunction:i(),onActivationFunction:o(a),onDeactivationFunction:s(a),rebindFunction:r(a),unbindAsyncFunction:e(),unbindFunction:t()})}_bind(n){return this._bindingDictionary.add(n.serviceIdentifier,n),new xn(n)}_buildBinding(n){const t=this.options.defaultScope||v.Transient;return new S(n,t)}async _getAll(n){return Promise.all(this._get(n))}_get(n){const t={...n,contextInterceptor:n=>n,targetType:w.Variable};if(this._middleware){const n=this._middleware(t);if(null==n)throw new Error("Invalid return type in middleware. Middleware must return!");return n}return this._planAndResolve()(t)}_getButThrowIfAsync(n){const t=this._get(n);if(X(t))throw new Error(`You are attempting to construct ${function(n){return"function"==typeof n?`[function/class ${n.name||"<anonymous>"}]`:"symbol"==typeof n?n.toString():`'${n}'`}(n.serviceIdentifier)} in a synchronous way but it has asynchronous dependencies.`);return t}_getAllArgs(n){return{avoidConstraints:!0,isMultiInject:!0,serviceIdentifier:n}}_getNotAllArgs(n,t,e,i){return{avoidConstraints:!1,isMultiInject:t,key:e,serviceIdentifier:n,value:i}}_planAndResolve(){return n=>{let t=J(this._metadataReader,this,n.isMultiInject,n.targetType,n.serviceIdentifier,n.key,n.value,n.avoidConstraints);t=n.contextInterceptor(t);const e=function(n){return un(n.plan.rootRequest.requestScope)(n.plan.rootRequest)}(t);return e}}_deactivateIfSingleton(n){if(n.activated)return Q(n.cache)?n.cache.then((t=>this._deactivate(n,t))):this._deactivate(n,n.cache)}_deactivateSingletons(n){for(const t of n){if(Q(this._deactivateIfSingleton(t)))throw new Error("Attempting to unbind dependency with asynchronous destruction (@preDestroy or onDeactivation)")}}async _deactivateSingletonsAsync(n){await Promise.all(n.map((async n=>this._deactivateIfSingleton(n))))}_propagateContainerDeactivationThenBindingAndPreDestroy(n,t,e){return this.parent?this._deactivate.bind(this.parent)(n,t):this._bindingDeactivationAndPreDestroy(n,t,e)}async _propagateContainerDeactivationThenBindingAndPreDestroyAsync(n,t,e){this.parent?await this._deactivate.bind(this.parent)(n,t):await this._bindingDeactivationAndPreDestroyAsync(n,t,e)}_removeServiceFromDictionary(n){try{this._bindingDictionary.remove(n)}catch(t){throw new Error(`Could not unbind serviceIdentifier: ${P(n)}`)}}_bindingDeactivationAndPreDestroy(n,t,e){if("function"==typeof n.onDeactivation){const i=n.onDeactivation(t);if(Q(i))return i.then((()=>this._preDestroy(e,t)))}return this._preDestroy(e,t)}async _bindingDeactivationAndPreDestroyAsync(n,t,e){"function"==typeof n.onDeactivation&&await n.onDeactivation(t),await this._preDestroy(e,t)}}class Bn{id;registry;constructor(n){this.id=A(),this.registry=n}}class Fn{id;registry;constructor(n){this.id=A(),this.registry=n}}function kn(n,t,e,i){!function(n){if(void 0!==n)throw new Error(R)}(t),$n(u,n,e.toString(),i)}function jn(n){let t=[];if(Array.isArray(n)){t=n;const e=function(n){const t=new Set;for(const e of n){if(t.has(e))return e;t.add(e)}}(t.map((n=>n.key)));if(void 0!==e)throw new Error(`${I} ${e.toString()}`)}else t=[n];return t}function $n(n,t,e,i){const r=jn(i);let o={};Reflect.hasOwnMetadata(n,t)&&(o=Reflect.getMetadata(n,t));let s=o[e];if(void 0===s)s=[];else for(const n of s)if(r.some((t=>t.key===n.key)))throw new Error(`${I} ${n.key.toString()}`);s.push(...r),o[e]=s,Reflect.defineMetadata(n,o,t)}function On(n){return(t,e,i)=>{"number"==typeof i?kn(t,e,i,n):function(n,t,e){if(void 0!==n.prototype)throw new Error(R);$n(h,n.constructor,t,e)}(t,e,n)}}function Vn(n,t){Reflect.decorate(n,t)}function Wn(n,t){return function(e,i){t(e,i,n)}}function Gn(n,t,e){"number"==typeof e?Vn([Wn(e,n)],t):"string"==typeof e?Reflect.decorate([n],t,e):Vn([n],t)}function Kn(){return function(n){if(Reflect.hasOwnMetadata(l,n))throw new Error("Cannot apply @injectable decorator multiple times.");const t=Reflect.getMetadata(g,n)||[];return Reflect.defineMetadata(l,t,n),n}}function Hn(n,t){return On(new V(n,t))}function Un(n){return On(new V(r,n))}function Ln(n){return t=>(e,i,r)=>{if(void 0===t){const n="function"==typeof e?e.name:e.constructor.name;throw new Error(`@inject called with undefined this could mean that the class ${n} has a circular dependency problem. You can use a LazyServiceIdentifer to overcome this limitation.`)}On(new V(n,t))(e,i,r)}}const Yn=Ln(c);function zn(){return On(new V(a,!0))}function Jn(){return function(n,t,e){kn(n,t,e,new V(s,!0))}}const Qn=Ln(d);function Xn(n){return function(t,e,i){kn(t,e,i,new V(o,n))}}function Zn(n,t){return()=>(e,i)=>{const r=new V(n,i);if(Reflect.hasOwnMetadata(n,e.constructor))throw new Error(t);Reflect.defineMetadata(n,r,e.constructor)}}const nt=Zn(y,"Cannot apply @postConstruct decorator multiple times in the same class"),tt=Zn(p,"Cannot apply @preDestroy decorator multiple times in the same class"),et=_;export{Fn as AsyncContainerModule,v as BindingScopeEnum,b as BindingTypeEnum,Pn as Container,Bn as ContainerModule,et as METADATA_KEY,E as MetadataReader,w as TargetTypeEnum,On as createTaggedDecorator,Gn as decorate,P as getServiceIdentifierAsString,A as id,Yn as inject,Kn as injectable,rn as multiBindToService,Qn as multiInject,Un as named,Sn as namedConstraint,zn as optional,nt as postConstruct,tt as preDestroy,Hn as tagged,An as taggedConstraint,Xn as targetName,mn as traverseAncerstors,In as typeConstraint,Jn as unmanaged};
//# sourceMappingURL=index.js.map
